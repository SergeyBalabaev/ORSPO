# Task020 ‚Äî Perf: –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ Linux üîç

## –ß—Ç–æ —Ç–∞–∫–æ–µ Perf?

**`Perf (Performance Counters for Linux)`** ‚Äî —ç—Ç–æ –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –≤ —è–¥—Ä–æ Linux. –û–Ω –ø–æ–∑–≤–æ–ª—è–µ—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å:

 * –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞

 * –ü—Ä–æ–º–∞—Ö–∏ –∫—ç—à–∞

 * –ü—Ä–æ–º–∞—Ö–∏ TLB (Translation Lookaside Buffer)

 * –í–µ—Ç–≤–ª–µ–Ω–∏—è –∏ –∏—Ö –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è

 * –°–æ–±—ã—Ç–∏—è —è–¥—Ä–∞

 * –ò –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ

–í –æ—Ç–ª–∏—á–∏–µ –æ—Ç `Valgrind`, –∫–æ—Ç–æ—Ä—ã–π —Å–∏–º—É–ª–∏—Ä—É–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (–º–µ–¥–ª–µ–Ω–Ω–æ), `Perf` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –Ω–∞–∫–ª–∞–¥–Ω—ã–º–∏ —Ä–∞—Å—Ö–æ–¥–∞–º–∏.

---

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Perf

```bash
# Ubuntu/Debian
sudo apt-get install linux-tools-common linux-tools-generic linux-tools-$(uname -r)

# Fedora/CentOS/RHEL
sudo dnf install perf

# Arch Linux
sudo pacman -S perf
```

---

## –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã Perf:

 | –°—á–µ—Ç—á–∏–∫ |  –ß—Ç–æ –∏–∑–º–µ—Ä—è–µ—Ç |
| :--- | :--- |
|`perf stat <program>`|–ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã —Å–æ —Å–±–æ—Ä–æ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (—Å—á–µ—Ç—á–∏–∫–∏)|
|`perf record <program>`|–ó–∞–ø–∏—Å—å –ø—Ä–æ—Ñ–∏–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ —Ñ–∞–π–ª `perf.data`|
|`perf report`|–ê–Ω–∞–ª–∏–∑ –∑–∞–ø–∏—Å–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è|
|`perf annotate`|–ü—Ä–æ—Å–º–æ—Ç—Ä –∞–Ω–Ω–æ—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ —Å –ø–æ–¥—Å—á–µ—Ç–æ–º –∑–∞—Ç—Ä–∞—Ç|
|`perf top`|–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–∞–º—ã—Ö "–≥–æ—Ä—è—á–∏—Ö" —Ñ—É–Ω–∫—Ü–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏|
|`perf list`|–°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞|

## –ß—Ç–æ –æ–∑–Ω–∞—á–∞—é—Ç —Å—á–µ—Ç—á–∏–∫–∏:

 | –ö–æ–º–∞–Ω–¥–∞ |  –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
| :--- | :--- |
|`task-clock`|–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö|
|`context-switches`|–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞|
|`cpu-migrations`|–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –º–µ–∂–¥—É —è–¥—Ä–∞–º–∏ CPU|
|`page-faults`|–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü|
|`cycles`|–¢–∞–∫—Ç–æ–≤—ã–µ —Ü–∏–∫–ª—ã –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞|
|`instructions`|–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π|
|`insn per cycle`|–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –∑–∞ —Ç–∞–∫—Ç (—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å)|
|`branches`|–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –≤–µ—Ç–≤–ª–µ–Ω–∏—è|
|`branch-misses`|–ù–µ–ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã–µ –≤–µ—Ç–≤–ª–µ–Ω–∏—è|

---

## –ó–∞–¥–∞–Ω–∏–µ 

* –°–∫–æ–º–ø–∏–ª–∏—Ä—É–π—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–º—É —É–º–Ω–æ–∂–µ–Ω–∏—è –º–∞—Ç—Ä–∏—Ü –∏–∑ Task019 —Å –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π:
    ```
    gcc -g -O2 MatrixMult.c -o MatrixMult -lm
    ```
* –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–∞–∑–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:
    ```
    perf stat ./MatrixMult 500
    ```
* –ó–∞–ø–∏—à–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
    ```
    perf record ./MatrixMult 500
    ```
* –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:
    ```
    perf report
    ```
* –ò–∑—É—á–∏—Ç–µ –∞–Ω–Ω–æ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ —Å–∞–º—ã—Ö "–≥–æ—Ä—è—á–∏—Ö" —Ñ—É–Ω–∫—Ü–∏–π:
    ```
    perf annotate
    ```

* –ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏:
    ```
    perf top
    ```

* –°—Ä–∞–≤–Ω–∏—Ç–µ —Ä–∞–∑–ª–∏—á–Ω—ã–µ –ø–æ—Ä—è–¥–∫–∏ —Ü–∏–∫–ª–æ–≤ (`ijk, ikj, jki`) —Å –ø–æ–º–æ—â—å—é `Perf`.